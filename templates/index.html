<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AIé™ªä¼´åŠ©æ‰‹ - æ™ºèƒ½æƒ…æ„Ÿåˆ†æ</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
      body {
        font-family: 'Microsoft YaHei', Arial, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
        font-size: 20px;
      }
      .container {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 16px rgba(0,0,0,0.12);
      }
      h2 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.2em;
      }
      .chat-container {
        border: 2px solid #2196f3;
        border-radius: 10px;
        height: 420px;
        overflow-y: scroll;
        padding: 18px;
        margin-bottom: 20px;
        background-color: #fafafa;
        font-size: 1.1em;
      }
      .message {
        margin-bottom: 18px;
        padding: 14px;
        border-radius: 10px;
        font-size: 1.1em;
      }
      .user-message {
        background-color: #e3f2fd;
        border-left: 6px solid #2196f3;
      }
      .ai-message {
        background-color: #f3e5f5;
        border-left: 6px solid #9c27b0;
      }
      .emotion-info {
        font-size: 15px;
        color: #444;
        margin-top: 7px;
        padding: 7px;
        background-color: #fff3cd;
        border-radius: 4px;
      }
      .input-section, .voice-section {
        margin-bottom: 24px;
        border: 2px dashed #bdbdbd;
        border-radius: 10px;
        background: #f7faff;
        padding: 18px 18px 10px 18px;
      }
      .input-section:focus-within, .voice-section:focus-within {
        border-color: #2196f3;
        box-shadow: 0 0 0 2px #90caf9;
      }
      textarea, input[type="file"] {
        width: 100%;
        padding: 14px;
        border: 2px solid #bdbdbd;
        border-radius: 7px;
        resize: vertical;
        font-family: inherit;
        font-size: 1.1em;
        outline: none;
        margin-bottom: 10px;
      }
      textarea:focus, input[type="file"]:focus {
        border-color: #2196f3;
        box-shadow: 0 0 0 2px #90caf9;
      }
      .btn {
        background-color: #2196f3;
        color: white;
        border: none;
        padding: 18px 32px;
        border-radius: 7px;
        cursor: pointer;
        margin: 8px 8px 8px 0;
        font-size: 1.1em;
        display: inline-flex;
        align-items: center;
        transition: background 0.2s;
      }
      .btn:focus {
        outline: 3px solid #1976d2;
        outline-offset: 2px;
      }
      .btn svg {
        margin-right: 8px;
      }
      .btn:hover {
        background-color: #1976d2;
      }
      .btn-danger {
        background-color: #f44336;
      }
      .btn-danger:hover {
        background-color: #d32f2f;
      }
      .btn-success {
        background-color: #4caf50;
      }
      .btn-success:hover {
        background-color: #388e3c;
      }
      .file-input {
        margin: 10px 0;
      }
      .status {
        margin-top: 16px;
        padding: 16px;
        border-radius: 6px;
        font-size: 1.1em;
        display: none;
        text-align: center;
      }
      .status.success {
        background-color: #d4edda;
        color: #155724;
        border: 2px solid #c3e6cb;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 2px solid #f5c6cb;
      }
      .loading {
        display: none;
        text-align: center;
        color: #1976d2;
        margin: 16px 0;
        font-size: 1.2em;
      }
      .section-title {
        font-size: 1.2em;
        color: #1976d2;
        margin-bottom: 8px;
        font-weight: bold;
      }
      .clear-btn {
        float: right;
        background: #f44336;
        color: #fff;
        font-size: 1em;
        padding: 8px 18px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        margin-top: -10px;
      }
      .clear-btn:focus {
        outline: 3px solid #d32f2f;
      }
      .progress-bar {
        width: 100%;
        height: 18px;
        background: #e0e0e0;
        border-radius: 8px;
        margin: 10px 0 0 0;
        overflow: hidden;
        display: none;
      }
      .progress-bar-inner {
        height: 100%;
        background: #2196f3;
        width: 0%;
        transition: width 0.2s;
      }
      .recording-indicator { display: none; }
      .recording-indicator.active { display: inline; color: #f44336; font-weight: bold; margin-left: 10px; }
    </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ¤– AI é™ªä¼´åŠ©æ‰‹ - æ™ºèƒ½æƒ…æ„Ÿåˆ†æ</h2>
    <button class="clear-btn" onclick="clearChat()" aria-label="æ¸…ç©ºèŠå¤©è®°å½•">ğŸ—‘ï¸ æ¸…ç©ºèŠå¤©</button>
    <div class="chat-container" id="chat_log" tabindex="0" aria-label="èŠå¤©è®°å½•"></div>

    <!-- æ–‡æœ¬è¾“å…¥ -->
    <div class="input-section" tabindex="0">
      <div class="section-title">ğŸ’¬ æ–‡æœ¬å¯¹è¯</div>
      <p style="font-size:18px;color:#888;">åœ¨ä¸‹æ–¹è¾“å…¥æ¡†è¾“å…¥å†…å®¹ï¼Œç‚¹å‡»â€œå‘é€æ¶ˆæ¯â€æˆ–æŒ‰å›è½¦å‘é€ã€‚</p>
      <textarea id="user_input" rows="3" placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¯´çš„è¯..." aria-label="æ–‡æœ¬è¾“å…¥åŒº"></textarea>
      <button class="btn" onclick="sendMessage()" aria-label="å‘é€æ¶ˆæ¯">
        <svg width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M2 21l21-9-21-9v7l15 2-15 2z"/></svg>
        å‘é€æ¶ˆæ¯
      </button>
    </div>

    <!-- è¯­éŸ³è¾“å…¥æ–¹å¼1ï¼šæ–‡ä»¶ä¸Šä¼  -->
    <div class="voice-section" tabindex="0">
      <div class="section-title">ğŸ“ æ–¹å¼ä¸€ï¼šä¸Šä¼ éŸ³é¢‘æ–‡ä»¶</div>
      <p style="font-size:18px;color:#888;">æ”¯æŒæ ¼å¼ï¼šWAV, PCM, AMR, M4Aï¼ˆæœ€å¤§10MBï¼‰ã€‚é€‰æ‹©æ–‡ä»¶åç‚¹å‡»â€œä¸Šä¼ å¹¶è¯†åˆ«â€ã€‚</p>
      <input type="file" id="audio_file" accept="audio/*" class="file-input" aria-label="ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶">
      <button class="btn" onclick="sendAudioFile()" aria-label="ä¸Šä¼ å¹¶è¯†åˆ«">
        <svg width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M5 20h14v-2H5m14-9h-4V3H9v6H5l7 7 7-7z"/></svg>
        ä¸Šä¼ å¹¶è¯†åˆ«
      </button>
    </div>

    <!-- è¯­éŸ³è¾“å…¥æ–¹å¼2ï¼šæµè§ˆå™¨å½•éŸ³ -->
    <div class="voice-section" tabindex="0">
      <div class="section-title">ğŸ¤ æ–¹å¼äºŒï¼šæµè§ˆå™¨å½•éŸ³</div>
      <p style="font-size:18px;color:#888;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹å½•éŸ³ï¼Œå†æ¬¡ç‚¹å‡»åœæ­¢å¹¶è‡ªåŠ¨è¯†åˆ«ã€‚å½•éŸ³æ—¶ä¼šæ˜¾ç¤ºè¿›åº¦ã€‚</p>
      <button class="btn btn-success" id="recordBtn" onclick="toggleRecording()" aria-label="å¼€å§‹å½•éŸ³">
        <svg width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3m5-3a1 1 0 0 1 2 0c0 3.87-3.13 7-7 7s-7-3.13-7-7a1 1 0 0 1 2 0c0 2.76 2.24 5 5 5s5-2.24 5-5M19 19v2H5v-2h14z"/></svg>
        å¼€å§‹å½•éŸ³
      </button>
      <span class="recording-indicator" id="recordingIndicator">â— å½•éŸ³ä¸­...</span>
      <div class="progress-bar" id="recordProgress"><div class="progress-bar-inner" id="progressBarInner"></div></div>
    </div>

    <!-- è¯­éŸ³è¾“å…¥æ–¹å¼3ï¼šå®æ—¶è¯­éŸ³è¯†åˆ« -->
    <div class="voice-section" tabindex="0">
      <div class="section-title">ğŸ”´ æ–¹å¼ä¸‰ï¼šå®æ—¶è¯­éŸ³è¯†åˆ«</div>
      <p style="font-size:18px;color:#888;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹å®æ—¶è¯†åˆ«ï¼Œé€‚åˆè¿ç»­å¯¹è¯ã€‚è¯†åˆ«æ—¶ä¼šæœ‰æ˜æ˜¾æç¤ºã€‚</p>
      <button class="btn btn-success" id="realtimeBtn" onclick="toggleRealtimeRecording()" aria-label="å¼€å§‹å®æ—¶è¯†åˆ«">
        <svg width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm0-14a6 6 0 1 1 0 12A6 6 0 0 1 12 6z"/></svg>
        å¼€å§‹å®æ—¶è¯†åˆ«
      </button>
      <span class="recording-indicator" id="realtimeIndicator">â— å®æ—¶è¯†åˆ«ä¸­...</span>
    </div>

    <div class="status" id="status"></div>
    <div class="loading" id="loading">å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>
  </div>
  <script>
    // èŠå¤©æ¶ˆæ¯è¿½åŠ åˆ°é¡µé¢
    function addMessage(content, isUser = true, emotionData = null, liwcData = null) {
      const chatLog = document.getElementById("chat_log");
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
      let html = `<strong>${isUser ? 'ä½ ' : 'AIåŠ©æ‰‹'}:</strong> ${content}`;
      if (emotionData && !isUser) {
        html += `<div class=\"emotion-info\">\n          <strong>æƒ…æ„Ÿåˆ†æ:</strong> \n          æ„¤æ€’: ${(emotionData.anger * 100).toFixed(1)}% | \n          æ‚²ä¼¤: ${(emotionData.sadness * 100).toFixed(1)}% | \n          å–œæ‚¦: ${(emotionData.joy * 100).toFixed(1)}% | \n          å¼ºåº¦: ${(emotionData.intensity * 100).toFixed(1)}%\n        </div>`;
      }
      if (liwcData && !isUser && Object.keys(liwcData).length > 0) {
        html += `<div class=\"emotion-info\"><strong>LIWCåˆ†æ:</strong> ` +
          Object.entries(liwcData).map(([k, v]) => `${k}: ${(v * 100).toFixed(1)}%`).join(' | ') +
          `</div>`;
      }
      messageDiv.innerHTML = html;
      chatLog.appendChild(messageDiv);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // æ–‡æœ¬å¯¹è¯
    async function sendMessage() {
      const userMessage = document.getElementById("user_input").value.trim();
      if (!userMessage) return;
      addMessage(userMessage, true);
      document.getElementById("user_input").value = "";
      toggleLoading(true);
      try {
        const response = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: userMessage })
        });
        const data = await response.json();
        if (data.error) {
          showStatus(data.error, 'error');
        } else {
          addMessage(data.reply, false, data.emotion, data.liwc);
        }
      } catch (error) {
        showStatus('å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message, 'error');
      } finally {
        toggleLoading(false);
      }
    }

    // ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
    async function sendAudioFile() {
      const fileInput = document.getElementById('audio_file');
      if (!fileInput.files.length) {
        showStatus('è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶', 'error');
        return;
      }
      const formData = new FormData();
      formData.append('audio', fileInput.files[0]);
      toggleLoading(true);
      try {
        const response = await fetch('/chat_audio', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        if (data.error) {
          showStatus(data.error, 'error');
          addMessage('[éŸ³é¢‘è¯†åˆ«å¤±è´¥]', true);
        } else {
          addMessage(data.text || '[éŸ³é¢‘å·²ä¸Šä¼ ]', true);
          addMessage(data.reply, false, data.emotion, data.liwc);
        }
      } catch (error) {
        showStatus('éŸ³é¢‘ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
      } finally {
        toggleLoading(false);
        fileInput.value = '';
      }
    }

    // å½•éŸ³è¿›åº¦æ¡å’Œå¤±è´¥è®¡æ•°
    let isRecording = false;
    let mediaRecorder, audioChunks = [];
    let recordTimer = null;
    let recordSeconds = 0;
    let maxRecordSeconds = 60; // æ”¯æŒæœ€é•¿60ç§’
    let recordFailCount = 0;
    function toggleRecording() {
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
    }
    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
          clearInterval(recordTimer);
          document.getElementById('progressBarInner').style.width = '0%';
          document.getElementById('recordProgress').style.display = 'none';
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          const formData = new FormData();
          formData.append('audio', audioBlob, 'record.wav');
          toggleLoading(true);
          try {
            const response = await fetch('/chat_audio', {
              method: 'POST',
              body: formData
            });
            const data = await response.json();
            if (data.error) {
              recordFailCount++;
              showStatus(data.error, 'error');
              addMessage('[å½•éŸ³è¯†åˆ«å¤±è´¥]', true);
              if (recordFailCount >= 3) {
                showStatus('å¤šæ¬¡å½•éŸ³è¯†åˆ«å¤±è´¥ï¼Œå»ºè®®å°è¯•æ–‡æœ¬è¾“å…¥ã€‚', 'error');
              }
            } else {
              recordFailCount = 0;
              addMessage(data.text || '[å½•éŸ³å·²å‘é€]', true);
              addMessage(data.reply, false, data.emotion, data.liwc);
            }
          } catch (error) {
            recordFailCount++;
            showStatus('å½•éŸ³å‘é€å¤±è´¥: ' + error.message, 'error');
            if (recordFailCount >= 3) {
              showStatus('å¤šæ¬¡å½•éŸ³è¯†åˆ«å¤±è´¥ï¼Œå»ºè®®å°è¯•æ–‡æœ¬è¾“å…¥ã€‚', 'error');
            }
          } finally {
            toggleLoading(false);
          }
        };
        mediaRecorder.start();
        isRecording = true;
        document.getElementById('recordBtn').textContent = 'åœæ­¢å½•éŸ³';
        document.getElementById('recordBtn').className = 'btn btn-danger';
        document.getElementById('recordingIndicator').classList.add('active');
        showStatus('å½•éŸ³å·²å¼€å§‹', 'success');
        // è¿›åº¦æ¡
        document.getElementById('recordProgress').style.display = 'block';
        recordSeconds = 0;
        recordTimer = setInterval(() => {
          recordSeconds++;
          let percent = Math.min(100, (recordSeconds / maxRecordSeconds) * 100);
          document.getElementById('progressBarInner').style.width = percent + '%';
          if (recordSeconds >= maxRecordSeconds) {
            stopRecording();
          }
        }, 1000);
      } catch (error) {
        showStatus('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message, 'error');
      }
    }
    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
      }
      isRecording = false;
      document.getElementById('recordBtn').textContent = 'å¼€å§‹å½•éŸ³';
      document.getElementById('recordBtn').className = 'btn btn-success';
      document.getElementById('recordingIndicator').classList.remove('active');
      showStatus('å½•éŸ³å·²åœæ­¢ï¼Œæ­£åœ¨è¯†åˆ«...', 'success');
      clearInterval(recordTimer);
      document.getElementById('progressBarInner').style.width = '0%';
      document.getElementById('recordProgress').style.display = 'none';
    }

    // å®æ—¶è¯­éŸ³è¯†åˆ«ï¼ˆä¼ªå®æ—¶ï¼Œå½•éŸ³ç»“æŸåä¸Šä¼ ï¼‰
    let isRealtimeRecording = false;
    let realtimeStream = null;
    let realtimeRecorder = null;
    let realtimeChunks = [];
    function toggleRealtimeRecording() {
      if (isRealtimeRecording) {
        stopRealtimeRecording();
      } else {
        startRealtimeRecording();
      }
    }
    async function startRealtimeRecording() {
      try {
        realtimeStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        realtimeRecorder = new MediaRecorder(realtimeStream);
        realtimeChunks = [];
        realtimeRecorder.ondataavailable = e => realtimeChunks.push(e.data);
        realtimeRecorder.onstop = async () => {
          if (realtimeChunks.length > 0) {
            const audioBlob = new Blob(realtimeChunks, { type: 'audio/wav' });
            const formData = new FormData();
            formData.append('audio', audioBlob, 'realtime.wav');
            try {
              const response = await fetch('/chat_audio', {
                method: 'POST',
                body: formData
              });
              const data = await response.json();
              if (!data.error) {
                addMessage(data.text || '[å®æ—¶è¯­éŸ³]', true);
                addMessage(data.reply, false, data.emotion, data.liwc);
              }
            } catch (error) {
              console.error('å®æ—¶è¯†åˆ«å¤±è´¥:', error);
            }
          }
        };
        realtimeRecorder.start();
        isRealtimeRecording = true;
        document.getElementById('realtimeBtn').textContent = 'åœæ­¢å®æ—¶è¯†åˆ«';
        document.getElementById('realtimeBtn').className = 'btn btn-danger';
        document.getElementById('realtimeIndicator').classList.add('active');
        showStatus('å®æ—¶è¯†åˆ«å·²å¼€å§‹', 'success');
      } catch (error) {
        showStatus('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message, 'error');
      }
    }
    function stopRealtimeRecording() {
      if (realtimeRecorder && realtimeRecorder.state !== 'inactive') {
        realtimeRecorder.stop();
        realtimeStream.getTracks().forEach(track => track.stop());
      }
      isRealtimeRecording = false;
      document.getElementById('realtimeBtn').textContent = 'å¼€å§‹å®æ—¶è¯†åˆ«';
      document.getElementById('realtimeBtn').className = 'btn btn-success';
      document.getElementById('realtimeIndicator').classList.remove('active');
      showStatus('å®æ—¶è¯†åˆ«å·²åœæ­¢', 'success');
    }

    // çŠ¶æ€å’ŒåŠ è½½æç¤º
    function showStatus(message, type = 'success') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';
      setTimeout(() => {
        status.style.display = 'none';
      }, 3000);
    }
    function toggleLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
    // å›è½¦å‘é€
    document.getElementById("user_input").addEventListener("keypress", function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    // èŠå¤©å†å²æ¸…ç©º
    function clearChat() {
      document.getElementById("chat_log").innerHTML = "";
      showStatus('èŠå¤©è®°å½•å·²æ¸…ç©º', 'success');
    }
    // Tabé”®å¯¼èˆªå’ŒARIA
    document.querySelectorAll('textarea, input, button, .chat-container, .input-section, .voice-section').forEach(el => {
      el.setAttribute('tabindex', '0');
    });
    // é¡µé¢åˆå§‹åŒ–æ¬¢è¿è¯­
    window.addEventListener('load', function() {
      addMessage('æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIé™ªä¼´åŠ©æ‰‹ã€‚å¯ä»¥è¿›è¡Œæ–‡å­—å¯¹è¯ï¼Œä¹Ÿæ”¯æŒè¯­éŸ³è¾“å…¥ã€‚è¯·é€‰æ‹©æ‚¨å–œæ¬¢çš„äº¤æµæ–¹å¼ã€‚', false);
    });
  </script>
</body>
</html>